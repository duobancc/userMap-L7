<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>火蝶云用户分布图</title>
	<style>
		html,
		body {
			overflow: hidden;
			margin: 0;
		}

		* {
			padding: 0;
			margin: 0;
		}
		.flex-row{
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.popup-html {
			background-color: antiquewhite;
			opacity: .5;
			padding: 20px 20px;
		}

		.popup-html>p {
			font-size: 18px;
			color: #474747;
		}

		.background-image {
			position: absolute;
			top: 0;
			left: 0;
			background: url(./img/big-bg.png) no-repeat;
			background-position: center;
			background-size: 100% 100%;
			width: 100vw;
			min-width: 1866px;
			height: 100vh;
			min-height: 1080px;
			/* text-align: center; */
		}

		.main {
			position: absolute;
			top: 0;
			left: calc((100% - 1866px) / 2);
			box-sizing: border-box;
			width: 1866px;
			height: 1080px;
			overflow: hidden;
		}
		.app{
			margin-top: 20px;
		}
		.app-main{
			justify-content: space-between;
		}

		.timer-date {
			/* height: 120px; */
			color: #00fbff;
			/* margin-top: 24px; */
			white-space: pre-line;
		}

		.menu {

		}
		.btn{
			width: 112px;
			height: 46px;
			font-size: 18px;
			font-weight: bold;
			color: #474747;
			background-color: #00fbff;
			border: none;
			outline:none;
		}
		.btn:active{
			border: tomato 2px solid;
		}
		.fullScreen{

		}
		.back{
			border: solid 2px #00fbff;
			background-color: #161a2a;
			color: white;
			margin-left: 16px;
		}

		#map {
			position: absolute;
			z-index: 0;
			width: 50%;
			height: 89.5%;
			top: 9.5%;
		}

		#customMap {
			position: absolute;
			width: 100%;
			height: 50vh;
		}

		.l7-popup-content {
			/* background-color: transparent !important; */
		}

		.l7-popup-tip {
			/* background-color: transparent !important; */
		}
	</style>
</head>

<body>

	<dvi class="background-image">
		<main class="main">
			<div class="app" id="app">

			</div>

			<div id="map"></div>
		</main>
	</dvi>

	<!-- 加载 React。-->
	<!-- 注意: 部署时，将 "development.js" 替换为 "production.min.js"。-->
	<script src="./modules/react.development.js" crossorigin></script>
	<script src="./modules/react-dom.development.js" crossorigin></script>
	<!-- 可以在Script 中使用jsx -->
	<script src="./modules/babel.min.js"></script>

	<!-- 加载我们的 React 组件。-->
	<script src="./js/timer.js"></script>

	<script src="./modules/l7.js"></script>
	<script src="./modules/l7-district.js"></script>
	<script src="./modules/axios.min.js"></script>
	<script src="./modules/moment-with-locales.js"></script>

	<script>
		const devBaseURL = 'https://dev.lexiangpingou.cn/summary_api.php'
		const proBaseURL = 'https://www.lexiangpingou.cn/summary_api.php'
		const instance = axios.create({
			baseURL: proBaseURL,
			timeout: 5000,
			method: 'post',
			headers: {
				'Content-Type': 'application/json'
			}
		})

		instance.interceptors.request.use(config => {
			console.log('request 拦截 ')

			return config
		}, err => {
			console.log('request 拦截  出错')

			return err
		})

		instance.interceptors.response.use(res => {
			console.log(' response 拦截')
			return res.data
		}, err => {
			if (err && err.response) {
				switch (err.response.status) {
					case 400:
						console.log("请求错误");
						break;
					case 401:
						console.log("未授权访问");
						break;
					default:
						console.log("其他错误信息");
				}
			}
			return err;
		})


		window.request = instance
	</script>


	<script type="text/babel">


		class TimerDate extends React.Component {

			constructor() {
				super()
				this.state = {
					date: ''
				}
			}

			render() {
				return (
					<div className="flex-row app-main" >
						<div className="timer-date">
							{this.state.date}
						</div>
						<div className="menu flex-row">
							<button className="fullScreen btn">
								全屏
							</button>
							<button className="back btn">
								返回
							</button>
						</div>
					</div>

				)
			}

			componentDidMount() {

				this.timer = setInterval(() => {
					const date = `${moment().format('YYYY年MM月DD日')}
          ${moment().format('HH:mm:ss dddd')}`
					this.setState({
						date,
					})

				}, 1000)
			}

			componentUnMount() {
				clearInterval(this.timer)
			}

		}

		ReactDOM.render(<TimerDate />, document.getElementById('app'))

	</script>


	<script>
		const getAreaData = async config => {
			let res = await request({
				params: {},
				data: {
					action: 'area_statistics',
					...config
				}
			})
			if (res.status === 1002) {
				return res.data
			} else {
				alert('请求数据错误')
				return false
			}
		}

		const color = [
			"rgb(255,255,217)",
			"rgb(237,248,177)",
			"rgb(199,233,180)",
			"rgb(127,205,187)",
			"rgb(65,182,196)",
			"rgb(29,145,192)",
			"rgb(34,94,168)",
			"rgb(12,44,132)"
		];

		const {
			Scene,
			GaodeMap,
			District,
			Marker,
			Popup,
			LineLayer,
			PolygonLayer,
			Control

		} = L7
		const {
			DrillDownLayer
		} = District


		const customDrillDownMap = () => {

			console.log('L7version: ' + L7.version)

			const color = [
				"rgb(255,255,217)",
				"rgb(237,248,177)",
				"rgb(199,233,180)",
				"rgb(127,205,187)",
				"rgb(65,182,196)",
				"rgb(29,145,192)",
				"rgb(34,94,168)",
				"rgb(12,44,132)"
			];

			const MyMap = new GaodeMap({
				center: [120.58657982223511, 27.770092808917987],
				pitch: 0,
				style: 'blank',
				rotation: 0,
				zoom: 6
			})

			const scene = new Scene({
				id: 'customMap',
				map: MyMap,
				logoVisible: false
			});



			fetch('https://gw.alipayobjects.com/os/bmw-prod/d6da7ac1-8b4f-4a55-93ea-e81aa08f0cf3.json')
				.then(res => res.json())
				.then(geo => {
					console.log(geo.features)
					const dataObj = {}
					tempData.forEach(item => {
						dataObj[item.name] = item
					})

					console.log(dataObj)

					geo.features = geo.features.map(item => {
						const name = item.properties.name
						item.properties = {
							...item.properties,
							...dataObj[name]
						}

						return item
					})
					console.log(geo)

					scene.on('loaded', () => {

						const chinaPolygonLayer = new PolygonLayer({
							autoFit: false
						})
							.source(geo);

						chinaPolygonLayer
							.color(
								'memberNum',
								(memberNum) => {
									let d = memberNum
									return d > 100 ?
										color[7] :
										d > 60 ?
											color[6] :
											d > 50 ?
												color[5] :
												d > 40 ?
													color[4] :
													d > 30 ?
														color[3] :
														d > 20 ?
															color[2] :
															d > 10 ?
																color[1] :
																color[0];
								}
							)
							// .color(
							// 	'density', (d ) => {
							// 			console.log(d)
							// 	})
							.shape('fill')
							// .active({
							// 	color: '#00fbff'
							// })
							.style({
								opacity: 1
							})

						const Layer2 = new LineLayer({
							zIndex: 2
						})
							.source(geo)
							.color('#474747')
							.size(0.6)
							.style({
								opacity: 0.7,
							})

						const hightLayer = new LineLayer({
							zIndex: 4,
							name: 'hightLight'
						})
							.source({
								type: 'FeatureCollection',
								features: []
							})
							.shape('line')
							.size(2)
							.color('#00fbff')
							.style({
								opacity: 1
							})

						chinaPolygonLayer.on('mousemove', e => {

							hightLayer.setData({
								type: 'FeatureCollection',
								features: [e.feature]
							})

							const popup = new Popup({
								offsets: [0, 0],
								closeButton: false
							})
								.setLnglat(e.lngLat)
								.setHTML(
									`<div>地区: ${e.feature.properties.name}
									</div>
									<div>
										数量：${e.feature.properties.memberNum ? e.feature.properties.memberNum : 0}
										</div>
									`
								)

							scene.addPopup(popup)
						})

						const legend = new Control({
							position: 'bottomright'

						})

						legend.onAdd = () => {
							// let color =  ['#1947d9', '#243dc9' ,'#071a75', '#00fbff' ];
							const color2 = [
								"rgb(255,255,217)",
								"rgb(237,248,177)",
								"rgb(199,233,180)",
								"rgb(127,205,187)",
								"rgb(65,182,196)",
								"rgb(29,145,192)",
								"rgb(34,94,168)",
								"rgb(12,44,132)"
							];
							let el = document.createElement('div')
							el.className = "infolegend legend"
							let grades = [0, 10, 20, 50, 100, 200, 500];
							// for (let i = 0; i < grades.length; i++) {
							// 	el.innerHTML +=
							// 		'<i style="background:' +
							// 		color2[i] +
							// 		'"></i> ' +
							// 		grades[i] +
							// 		(grades[i + 1] ? "–" + grades[i + 1] + "<br>" : "+");
							// }

							return el
						}
						scene.addLayer(chinaPolygonLayer)
						scene.addLayer(Layer2)
						scene.addLayer(hightLayer)
						scene.addControl(legend)
					})


				})

		}




		const DrillDownMap = async () => {

			let provinceData = await getAreaData({
				type: 1,
				code: ''
			})
			const colors = ['#1947d9', '#071a75', '#243dc9'];
			const scene = new Scene({
				id: 'map',
				map: new GaodeMap({
					center: [120.58657982223511, 27.770092808917987],
					pitch: 0,
					style: 'blank',
					zoom: 4,
				}),
				logoVisible: false
			});


			// const popup = new Popup({
			// 	offsets: [0, 20],
			// 	color: '#ff762e'
			// }).setText('火蝶信息科技');
			// const marker = new Marker()
			// 	.setLnglat([120.58657982223511, 27.770092808917987])
			// 	.setPopup(popup)


			// scene.addMarker(marker)




			scene.on('loaded', () => {


				const drillLayer = new DrillDownLayer(scene, {
					customTrigger: false,
					data: [],
					joinBy: ['NAME_CHN', 'name'],
					depth: 0,
					province: {
						// chinaNationalStroke: '#474747', // 国界线
						// chinaNationalWidth: 2,
						// coastlineStroke: '#ff762e', //海岸线
						// coastlineWidth: 1,
						// nationalStroke: '#ff762e',
						depth: 1,
						provinceStroke: '#10405a', // 省界线
						autoFit: true,
						data: provinceData
					},
					city: {
						cityStroke: '#10405a',
						cityStrokeWidth: 1,
						autoFit: true,
						// fill: {
						// 	color: {
						// 		file: 'member'
						// 	}
						// }

					},
					country: {
						cityStroke: '#10405a',
						cityStrokeWidth: 1,
						autoFit: true,
					},
					viewStart: 'Country',
					viewEnd: 'City',
					fill: {
						color: {
							field: 'memberNum',
							values: (memberNum) => {
								let d = memberNum
								return d > 100 ?
									color[7] :
									d > 60 ?
										color[6] :
										d > 40 ?
											color[5] :
											d > 25 ?
												color[4] :
												d > 15 ?
													color[3] :
													d > 10 ?
														color[2] :
														d > 5 ?
															color[1] :
															d > 0 ?
																color[0] :
																'white';
							}
						},
						activeColor: '#00fbff'
					},
					label: {
						size: 16,
					},
					popup: {
						enable: true,
						Html: props => {
							return `
								<div class="popup-html">
									<p>${props.NAME_CHN} </p>
									<p>${props.memberNum ? props.memberNum : 0} 家</p>
								</div>
								`
						},
						// maxWidth: 40,

					}
				})

				// const popup = new Popup({
				// 	offsets: [0, 0],
				// 	closeButton: false
				// })


				// drillLayer.provinceLayer.on('mousemove', (e) => {
				// 	// console.log(e.feature.properties)
				// 	let i = e.feature.properties
				// 	const popupHTML = `
				// 			<p>省份
				// 				${i.NAME_CHN} </p>
				// 				<p>地区
				// 			  ${i.memberNum ? i.memberNum : 0}</p><p>数值
				// 			  ${i.x}</p>
				// 		`
				// 	popup.setLnglat([i.x, i.y])
				// 	popup.setHTML(popupHTML)
				// })

				// scene.addPopup(popup)

				drillLayer.provinceLayer.on('click', async (e) => {

					let areacode = e.feature.properties.areacode

					let cityData = await getAreaData({
						type: 2,
						code: areacode
					})
					console.log(areacode)
					drillLayer.drillDown([areacode], cityData)

				})


				drillLayer.cityLayer.on('click', async (e) => {

					let areacode = e.feature.properties.areacode

					let countryData = await getAreaData({
						type: 3,
						code: areacode
					})

					console.log(areacode)
					drillLayer.drillDown([areacode], countryData)

				})



			})





		}
		// customDrillDownMap()
		DrillDownMap()
	</script>
</body>

</html>