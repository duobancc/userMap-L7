<!DOCTYPE html>
<html lang="en-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>火蝶云用户分布图</title>
	<link rel="stylesheet" href="./style/user-map.css">
</head>

<body>

	<dvi class="background-image">
		<main class="main">
			<div class="app" id="app">
			</div>
			<div id="map"></div>
		</main>

		<!-- 地图四角 -->
		<img class="rahmen-top-left rahmen" src="./img/rahmen-icon.png" />
		<img class="rahmen-top-right rahmen" src="./img/rahmen-icon.png" />
		<img class="rahmen-bottom-left rahmen" src="./img/rahmen-icon.png" />
		<img class="rahmen-bottom-right rahmen" src="./img/rahmen-icon.png" />
		<!-- 图例 -->
		<div class="map-lengen flex-row">
			<div class="lengen-text flex-column">
				<span>高</span>
				<span>低</span>
			</div>
			<ul>
				<li style="background: #071A75;"></li>
				<li style="background: #0929A5;"></li>
				<li style="background: #1947D9;"></li>
				<li style="background: #243DC9;"></li>
			</ul>
		</div>

		<!-- 商家服务数量 -->
		<div class="service-businesses-num flex-column">
			<p class="sbn-text">火蝶云已服务商家</p>
			<div class="sbn-line"></div>
			<p class="sbn-num" id="allBusinessNum"> 532<span>家</span> </p>
		</div>
		<!-- 中华人民共和国 -->
		<div class="china flex-row">
			<img class="location-icon" src="./img/location-icon.png" />
			<p class="china-text">中华人民共和国</p>
		</div>
	</dvi>

	<!-- 加载 React。-->
	<!-- 注意: 部署时，将 "development.js" 替换为 "production.min.js"。-->
	<script src="./modules/react.development.js" crossorigin></script>
	<script src="./modules/react-dom.development.js" crossorigin></script>
	<!-- 可以在Script 中使用jsx -->
	<script src="./modules/babel.min.js"></script>

	<script src="./modules/l7.js"></script>
	<script src="./modules/l7-district.js"></script>
	<script type="text/javascript" src="./modules/charts.min.js"></script>

	<script src="./modules/axios.min.js"></script>
	<script src="./modules/moment-with-locales.js"></script>

	<script>
		const devBaseURL = 'https://dev.lexiangpingou.cn/summary_api.php'
		const proBaseURL = 'https://www.lexiangpingou.cn/summary_api.php'
		const instance = axios.create({
			baseURL: proBaseURL,
			timeout: 6000,
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			}
		})

		instance.interceptors.request.use(config => {
			console.log('request 拦截 ')

			return config
		}, err => {
			console.log('request 拦截  出错')

			return err
		})

		instance.interceptors.response.use(res => {
			console.log(' response 拦截')
			return res.data
		}, err => {
			if (err && err.response) {
				switch (err.response.status) {
					case 400:
						console.log("请求错误");
						break;
					case 401:
						console.log("未授权访问");
						break;
					default:
						console.log("其他错误信息");
				}
			}
			return err;
		})


		window.request = instance
	</script>

	<script type="text/babel">
		moment.locale('zh-cn')
		const { useState, useRef, useEffect, memo } = React

		const RegionalRanking = memo(() => {

			const selectRef = useRef()
			const { Column, Rose } = charts
			const [ranking, setRanking] = useState([])
			const [regional, setRegional] = useState([])


			useEffect(() => {
				const getRanking = request({
					data: {
						action: 'Regional_ranking',
						code: "",
						type: 1,
					}
				})
				const getRegional = request({
					data: {
						action: 'area_sort',
						type: 0
					}
				})

				axios.all([getRanking, getRegional]).then(axios.spread((ran, reg) => {
					reg.status === 200 && setRegional(reg.data)
					reg.status !== 200 && alert('接口错误')
					ran.status === 1002 && setRanking(ran.data)
					ran.status !== 1002 && alert('接口错误')
				}))

				return () => {

				}
			}, [])

			const color = ['#fff', '#E66784', '#05C6FF', '#01F1E8', '#1578ED']

			const roseConfig = {
				data: regional,
				xField: 'type',
				yField: 'value',
				seriesField: 'type',
				radius: 1,
				innerRadius: .3,
				legend: false,
				sectorStyle: {
					stroke: '#161d31'
				},
				color: color,
				label: {
					style: {
						fill: '#01F1E8',
						opacity: 0,
						fontSize: 12
					},
					rotate: true
				}

			};

			const columnConfig = {
				data: ranking,
				autoFit: true,
				xField: 'name',
				yField: 'memberNum',
				point: {
					size: 5,
					shape: 'diamond',
				},
				columnStyle: {
					fill: 'l(270) 0:#1e3945 1:#47d6d9',
					fillOpacity: 1,
					lineOpacity: .5,
				},
				xAxis: {
					grid: null,
					label: {
						style: {
							fill: '#fff',
							fontSize: 14,
							fontWeight: 400
						},
						autoRotate: false
					}
				},
				yAxis: {
					grid: {
						line: {
							style: {
								stroke: '#00FBFF',
								opacity: .6
							}
						}
					},
					label: {
						style: {
							fill: '#00FBFF',
							fontSize: 8,
							fontWeight: 400
						}
					}
				},
				scrollbar: {
					type: 'horizontal',
					backgroundStyle: {
						fill: '#fff',
						color: '#fff',
						backgroundColor: '#fff'
					},
					handlerStyle: {
						fill: '#fff',
						color: '#fff',
						backgroundColor: '#fff'


					}
				}


			};

			return (
				regional.length > 1 && ranking.length > 1 &&
				<div className="regional-ranking" id="regional-ranking">
					<div className="regional">
						<p className="regional-title">区域排名</p>
						<div className="regional-container flex-row">
							<div className="account-for-regional">
								{regional.length > 1 && <Rose {...roseConfig} />}
							</div>
							<ul className="regional-legend ">
								<li> <span className="light-point c1"  ></span> 华南区： <span className="regional-value" style={{ color: '#fff' }} > {regional[0].value} </span></li>
								<li> <span className="light-point c2" ></span>华东区： <span className="regional-value" style={{ color: '#1578ED' }}> {regional[1].value} </span></li>
								<li> <span className="light-point c3"></span>西南区： <span className="regional-value" style={{ color: '#01F1E8' }}> {regional[2].value} </span></li>
								<li> <span className="light-point c4" ></span>华中区： <span className="regional-value" style={{ color: '#05C6FF' }}> {regional[3].value} </span></li>
								<li> <span className="light-point c5" ></span>华北区： <span className="regional-value" style={{ color: '#E66784' }}> {regional[4].value} </span></li>
							</ul>
						</div>
					</div>

					<div className="ranking">
						<div className="ranking-top flex-row">
							<p className="ranking-title">地区排名(Top10)</p>

							<select  className='select-area' id="" onChange={(e) => {
								console.log(e.target.value)

								request({
									data: {
										action: 'Regional_ranking',
										code: "",
										type: e.target.value,
									}
								}).then(ran => {
									ran.status === 1002 && setRanking(ran.data)
									ran.status !== 1002 && alert('接口错误')
								})

							}}
							>
								<option value="0">请选择</option>
								<option value="1">省份</option>
								<option value="2">城市</option>
								<option value="3">区域</option>
							</select>
						</div>
						<div className="top10">
							<Column {...columnConfig} />
						</div>
					</div>


				</div>
			)
		})

		// 商家分布图 
		const BusinessDistribution = memo(() => {

			const timer = useRef()
			const dataLenth = useRef()
			const [data, setData] = useState([])
			const [number, setNumber] = useState({ start: -1, end: 6 })

			useEffect(() => {
				request({
					data: {
						action: 'area_distributed',
						code: "",
						type: 1,
					}
				}).then(res => {
					dataLenth.current = res.data.length
					res.status === 1002 && setData(res.data)
					res.status !== 1002 && alert('接口错误')
				})


				timer.current = setInterval(() => {
					setNumber((pre) => {
						// console.log(pre, new Date().getTime(), dataLenth.current)
						let update = {}
						update.start = pre.start
						update.end = pre.end

						if (dataLenth.current > update.end) {
							update.start += 1
							update.end += 1
							return { ...pre, ...update }
						} else {
							update.start = -1
							update.end = 6
							return { ...pre, ...update }
						}
					})
				}, 1000)

				return () => {
					clearInterval(timre.current)
				}
			}, [])


			// console.log('渲染商家分布', number)

			return (
				<div className="business-distribution">
					<p className="bd-title">商家分布</p>
					<div className="bd-box">
						<table>
							<thead>
								<tr>
									<th>省份</th>
									<th>市</th>
									<th>区</th>
									<th>商家名称</th>
									<th>活跃用户</th>
								</tr>
							</thead>
							<tbody>
								{
									data.length > 1 &&
									data.slice(number.start, number.end).map((item, key) => {
										return <tr key={key + item.uniacid}>
											<td>{item.province ? item.province : '未知'}</td>
											<td>{item.city ? item.city : '未知'}</td>
											<td>{item.district ? item.district : '未知'}</td>
											<td>{item.name}</td>
											<td> {item.num} </td>
										</tr>
									})
								}
							</tbody>

						</table>
					</div>
				</div>
			)
		})

		const Title = memo(() => {
			let timer
			const textGradient = useRef()

			useEffect(() => {
				let s = 0;
				let e = 12;
				timer = setInterval(function () {
					s++
					e++
					textGradient.current.style.background = 'linear-gradient(109deg, #04d8ee ' + s + '%, #fff, #04d8ee ' + e + '%)';
					if (e >= 100) {
						s = 0
						e = 12
					}
				}, 50)
				return () => {
					clearInterval(timer)
				}
			}, [])

			console.log('Title 渲染=======')

			return (
				<p className="user-title" ref={textGradient}>火蝶云用户分布中心
				</p>
			)
		})

		const Timer = memo(props => {
			let timer = null
			const [date, setDate] = useState('')
			useEffect(() => {
				timer = setInterval(() => {
					const date = `${moment().format('YYYY年MM月DD日')}
          ${moment().format('HH:mm:ss dddd')}`
					setDate(date)
				}, 1000)
				return () => {
					clearInterval(this.timer)
				}
			}, [])

			return (
				<div className="timer-date">
					{date}
				</div>
			)
		})

		const TimerDate = () => {
			const [title, setTitle] = useState(false)

			let linsenKey


			// useEffect(() => {

			// 	document.addEventListener('keydown', function (e) {
			// 		if (e && e.keyCode === 122) {

			// 		} else if (e && e.keyCode === 27) {

			// 		}
			// 	})

			// 	return () => {

			// 	}
			// }, [])




			return (
				<div>
					<div className="flex-row app-main" >
						<Timer />
						<Title />
						<div className="menu flex-row">
							<button className="fullScreen btn" onClick={fullScreen}>
								{title ? '退出全屏' : '全屏'}
							</button>
							<button className="back btn" onClick={() => { location.href = location.href.replace('userMap.html', 'index.html') }}>
								首页
							</button>
						</div>

						<BusinessDistribution />
						<RegionalRanking />



					</div>
				</div>
			)

			function fullScreen() {

				if (!document.fullscreenElement) {
					setTitle(true)
					document.documentElement.requestFullscreen();
				} else {
					if (document.exitFullscreen) {
						setTitle(false)
						document.exitFullscreen();
					}
				}

				// let element = document.documentElement
				// if (element.requestFullscreen) {
				// 	element.requestFullscreen();
				// } else if (element.mozRequestFullScreen) {
				// 	element.mozRequestFullScreen();
				// } else if (element.webkitRequestFullscreen) {
				// 	element.webkitRequestFullscreen();
				// } else if (element.msRequestFullscreen) {
				// 	element.msRequestFullscreen();
				// }
			}
		}

		ReactDOM.render(<TimerDate />, document.getElementById('app'))
	</script>

	<script>
		const getAreaData = async config => {
			let res = await request({
				params: {},
				data: {
					action: 'area_statistics',
					...config
				}
			})
			if (res.status === 1002) {
				return res.data
			} else {
				return false
			}
		}

		const color = [
			"#071A75",
			"#0929A5",
			"#1947D9",
			"#243DC9",
		];
		// color.reverse()
		// #222a41
		// #161c2c
		const {
			Scene,
			GaodeMap,
			District,
			Marker,
			Popup,
			LineLayer,
			PolygonLayer,
			Control
		} = L7
		const {
			DrillDownLayer
		} = District
		const customDrillDownMap = async () => {

			let provinceData = await getAreaData({
				type: 1,
				code: ''
			})

			console.log(provinceData)


			const MyMap = new GaodeMap({
				center: [105.58657982223511, 32.770092808917987],
				pitch: 0,
				style: 'blank',
				zoom: 4.5,
				dragEnable: false,
				zoomEnable: true
			})

			const scene = new Scene({
				id: 'map',
				map: MyMap,
				logoVisible: false
			});



			fetch('https://gw.alipayobjects.com/os/bmw-prod/d6da7ac1-8b4f-4a55-93ea-e81aa08f0cf3.json')
				.then(res => res.json())
				.then(geo => {
					console.log(geo.features)
					const dataObj = {}
					let sum
					provinceData.forEach(item => {
						dataObj[item.name] = item
						console.log(item.memberNum)
						sum += parseInt(item.memberNum)
					})

					console.log(dataObj, sum)

					geo.features = geo.features.map(item => {
						const name = item.properties.name
						item.properties = {
							...item.properties,
							...dataObj[name]
						}

						return item
					})
					console.log(geo)

					scene.on('loaded', () => {

						const chinaPolygonLayer = new PolygonLayer({
							autoFit: false,

						})
							.source(geo);

						chinaPolygonLayer
							.color(
								'memberNum',
								(memberNum) => {

									let d = memberNum

									console.log(typeof memberNum, typeof d)

									return d > 100 ?
										color[3] :
										d > 50 ?
											color[2] :
											d > 30 ?
												color[1] :
												d > 0 ? color[1] :
													color[0];
								}
							)
							// .color(
							// 	'density', (d ) => {
							// 			console.log(d)
							// 	})
							.shape('fill')
							// .active({
							// 	color: '#00fbff'
							// })
							.style({
								opacity: 1
							})

						const Layer2 = new LineLayer({
							zIndex: 2
						})
							.source(geo)
							.color('#474747')
							.size(0.6)
							.style({
								opacity: 0.7,
							})

						const hightLayer = new LineLayer({
							zIndex: 4,
							name: 'hightLight'
						})
							.source({
								type: 'FeatureCollection',
								features: []
							})
							.shape('line')
							.size(2)
							.color('#00fbff')
							.style({
								opacity: 1
							})

						chinaPolygonLayer.on('mousemove', e => {

							hightLayer.setData({
								type: 'FeatureCollection',
								features: [e.feature]
							})

							const popup = new Popup({
								offsets: [0, 0],
								closeButton: false
							})
								.setLnglat(e.lngLat)
								.setHTML(
									`<div>地区: ${e.feature.properties.name}
									</div>
									<div>
										数量：${e.feature.properties.memberNum ? e.feature.properties.memberNum : 0}
									</div>
									`
								)
							scene.addPopup(popup)
						})

						const legend = new Control({
							position: 'bottomright'
						})

						scene.addLayer(chinaPolygonLayer)
						scene.addLayer(Layer2)
						scene.addLayer(hightLayer)
						// scene.addControl(legend)
					})
				})
		}


		const DrillDownMap = async () => {
			let provinceData = await getAreaData({
				type: 1,
				code: ''
			})

			let sum = 0
			provinceData.forEach(item => {
				return sum += parseInt(item.memberNum)
			})


			const scene = new Scene({
				id: 'map',
				map: new GaodeMap({
					center: [106.58657982223511, 40],
					pitch: 0,
					style: 'blank',
					zoom: 4.5,
					dragEnable: false,
					zoomEnable: false
				}),
				logoVisible: false
			});

			scene.on('loaded', () => {

				const drillLayer = new DrillDownLayer(scene, {
					customTrigger: false,
					data: [],
					joinBy: ['NAME_CHN', 'name'],
					depth: 0,
					province: {
						// chinaNationalStroke: '#474747', // 国界线
						// chinaNationalWidth: 2,
						// coastlineStroke: '#ff762e', //海岸线
						// coastlineWidth: 1,
						// nationalStroke: '#ff762e',
						depth: 1,
						provinceStroke: 'white', // 省界线
						autoFit: false,
						data: provinceData
					},
					city: {
						cityStroke: 'white',
						cityStrokeWidth: 1,
						autoFit: true,
						// fill: {
						// 	color: {
						// 		file: 'member'
						// 	}
						// }
					},
					country: {
						cityStroke: 'white',
						cityStrokeWidth: 1,
						autoFit: true,
					},
					viewStart: 'Country',
					viewEnd: 'City',
					fill: {
						color: {
							field: 'memberNum',
							values: color
						},
						activeColor: '#00fbff',
					},
					label: {
						size: 16,
					},
					popup: {
						enable: true,
						Html: props => {
							return `
								<div class="popup-html">
									<p>${props.NAME_CHN} </p>
									<p>${props.memberNum ? props.memberNum : 0} 家</p>
								</div>
								`
						},
						// maxWidth: 40,
					}
				})

				drillLayer.provinceLayer.on('mousemove', e => {
					heightLayer.setData({
						type: 'FeatureCollection',
						features: [e.feature]
					})
				})

				drillLayer.cityLayer.on('mousemove', e => {
					heightLayer.setData({
						type: 'FeatureCollection',
						features: [e.feature]
					})
				})



				drillLayer.provinceLayer.on('click', async (e) => {
					let areacode = e.feature.properties.areacode
					let cityData = await getAreaData({
						type: 2,
						code: areacode
					})

					if (cityData) {
						drillLayer.drillDown([areacode], cityData)
					} else {
						alert('该地区无数据')
					}
				})


				drillLayer.cityLayer.on('click', async (e) => {

					let areacode = e.feature.properties.areacode

					let countryData = await getAreaData({
						type: 3,
						code: areacode
					})

					if (countryData) {
						drillLayer.drillDown([areacode], countryData)
					} else {
						alert('该地区无数据')
					}

				})

				const legend = new Control({
					position: 'bottomright',

				})

				legend.onAdd = () => {
					let el = document.createElement('ul')
					el.className = 'infolegend legend'
					for (let i = 0; i < color.length; i++) {
						el.innerHTML += `
								<li style="background:${color[i]}">
								</li>
							`
					}
					return el
				}

				const heightLayer = new LineLayer({
					name: 'heightLight'
				})
					.source({
						type: 'FeatureCollection',
						features: []
					})
					.shape('line')
					.size(4)
					.color('#00fbff')

				// scene.addControl(legend)
				// scene.addLayer(heightLayer)

				// let el = document.getElementById('allBusinessNum')
				// console.log( el )
				// el.innerHTML(`${sum}<span>家</span>`)


			})
		}
		// customDrillDownMap()
		DrillDownMap()
	</script>
</body>

</html>